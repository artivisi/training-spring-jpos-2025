<?xml version="1.0" encoding="UTF-8"?>
<txnmgr name="transactionManager" class="org.jpos.transaction.TransactionManager" logger="Q2">
    <property name="space" value="tspace:default" />
    <property name="queue" value="txnmgr" />
    <property name="sessions" value="10" />
    <property name="max-sessions" value="128" />
    <property name="debug" value="true" />

    <!-- ===== COMMON PARTICIPANTS: Run for ALL message types ===== -->

    <!-- Sign-on validation - terminals must sign on before transacting (allows 0800 messages) -->
    <participant class="com.artivisi.atm.jpos.participant.SignOnValidationParticipant" logger="Q2" realm="signon-validation" />

    <!-- ===== SELECTOR: Routes to appropriate group based on MTI and fields ===== -->

    <participant class="com.artivisi.atm.jpos.participant.MTISelector" logger="Q2" realm="mti-selector" />

    <!-- ===== GROUP: NetworkManagement (0800 + field 70) ===== -->
    <!-- Handles sign-on/sign-off messages -->

    <group name="NetworkManagement">
        <!-- MAC verification to verify message integrity -->
        <participant class="com.artivisi.atm.jpos.participant.MacVerificationParticipant" logger="Q2" realm="mac-verification-network" />
        <!-- Sign-on/sign-off response handling -->
        <participant class="com.artivisi.atm.jpos.participant.SignOnResponseParticipant" logger="Q2" realm="signon-response" />
    </group>

    <!-- ===== GROUP: KeyChange (0800 + field 53) ===== -->
    <!-- Handles key rotation messages -->

    <group name="KeyChange">
        <!-- MAC verification (REUSED from NetworkManagement group) -->
        <participant class="com.artivisi.atm.jpos.participant.MacVerificationParticipant" logger="Q2" realm="mac-verification-keychange" />
        <!-- Key change handling -->
        <participant class="com.artivisi.atm.jpos.participant.KeyChangeParticipant" logger="Q2" realm="key-change" />
    </group>

    <!-- ===== GROUP: FinancialTransaction (0200) ===== -->
    <!-- Handles balance inquiry and cash withdrawal -->

    <group name="FinancialTransaction">
        <!-- MAC verification (REUSED from other groups) -->
        <participant class="com.artivisi.atm.jpos.participant.MacVerificationParticipant" logger="Q2" realm="mac-verification-financial" />
        <!-- Account validation before PIN verification - no need to verify PIN for non-existent accounts -->
        <participant class="com.artivisi.atm.jpos.participant.AccountValidationParticipant" logger="Q2" realm="account-validation" />
        <!-- PIN verification (only for financial transactions) -->
        <participant class="com.artivisi.atm.jpos.participant.PinVerificationParticipant" logger="Q2" realm="pin-verification" />
        <!-- Business logic participants -->
        <participant class="com.artivisi.atm.jpos.participant.BalanceInquiryParticipant" logger="Q2" realm="balance-inquiry" />
        <participant class="com.artivisi.atm.jpos.participant.WithdrawalParticipant" logger="Q2" realm="withdrawal" />
    </group>

    <!-- ===== POST-GROUP PARTICIPANTS: Run after group processing ===== -->
    <!-- These always run regardless of which group was selected -->

    <!-- Response builder - constructs ISO-8583 response message -->
    <participant class="com.artivisi.atm.jpos.participant.ResponseBuilderParticipant" logger="Q2" realm="response-builder" />
    <!-- Send response - transmits response and generates MAC in commit phase -->
    <participant class="com.artivisi.atm.jpos.participant.SendResponseParticipant" logger="Q2" realm="send-response" />
    <!-- Key activation - activates PENDING keys when terminal uses them -->
    <participant class="com.artivisi.atm.jpos.participant.KeyActivationParticipant" logger="Q2" realm="key-activation" />
</txnmgr>
